# 程序化迷宫生成规则文档

本文档详细描述了一个Python脚本的需求。该脚本可以根据预设的轨道表.csv，以及代码内置的规则，生成一个代表了迷宫布局的脚本。该迷宫布局脚本会被用于 3D 物理迷宫游戏《迷宫球》的迷宫搭建。

## 文档概述

本文档定义了迷宫生成系统的核心概念、数据结构和算法规则。实现遵循以下设计原则：

- **模块化**: 基于预定义的轨道模块构建迷宫
- **可扩展性**: 支持添加新的轨道类型和规则
- **可配置性**: 通过参数调整生成行为
- **可验证性**: 提供完整的验证机制

---

## 1. 基础概念 (Fundamental Concepts)

### 迷宫 (Maze)

由一系列轨道模块拼接而成的、可供玩家挑战的完整三维路径结构。

### 空间 (Space)

- **建造空间 (Build Space):** 迷宫可占据的物理范围。
- **安全区 (Safety Zone):** 比建造空间更大的外部边界，用于判断失败（如小球掉落）。

### 单位换算 (Unit Conversion)

所有逻辑尺寸以"迷宫单元（Block Unit）"为单位。导出至 UE5 时，换算为：

- `1 单元 = 16 厘米 (cm)`

### 轨道 (Track)

构成迷宫的基本模块化单元，属性如下：

| 属性名称      | 数据类型         | 描述                             | 示例值 |
|---------------|------------------|----------------------------------|--------|
| Name          | 字符串 (String)  | 轨道唯一名称，来自 CSV 文件       | "BP_Start_F_X1_Y1_Z1_Rail" |
| Index         | 整数 (Integer)   | 基于 Name 生成的哈希值           | 34598712 |
| Size          | 元组 (Tuple)     | 占用的空间尺寸 (x, y, z)         | (1, 1, 1) |
| Difficulty    | 浮点数 (Float)   | 轨道的基础难度值                 | 13.5 |
| Exits         | 列表 (List)      | 包含多个出口信息                  | [ exit1, exit2, ... ] |

**出口属性（每项）：**

- **朝向 (Direction):** 相对方向，如 `"Y+"`
- **相对坐标 (Relative Pos):** 坐标偏移，如 `(0, 1, 0)`
- **允许旋转 (Allowed Rotations):** 自旋角度，如 `[0, 90, 180, 270]`

---

## 2. 输入参数 (Input Parameters)

| 参数名称              | 类型             | 描述 |
|-----------------------|------------------|------|
| 轨道配置表 CSV Path   | 字符串           | 所有轨道模块定义文件路径 |
| 目标难度范围          | (int, int) 元组  | 迷宫总难度的上下限 |
| 建造空间尺寸          | 奇数整数         | 建造空间立方体边长（单位：单元） |
| 安全区尺寸            | 奇数整数         | 安全边界立方体边长 |
| 检查点数量            | 整数             | 期望生成的检查点数量 |

---

## 3. 空间与坐标系 (Space & Coordinate System)

### 坐标系统

- **右手坐标系：** +X 前，+Y 右，+Z 上
- **逻辑中心点：** (0, 0, 0)

### 世界坐标对齐

- **世界偏移量：** `WorldOffset.Z = (SafetyZoneSize - 1) / 2`
- 示例：建造空间 17，安全区 31 ⇒ 中心点对应世界坐标 (0, 0, 15)

### 轨道坐标系与变换

#### 局部坐标系

- 轴向：+X 前，+Y 右，+Z 上
- 原点：轨道底部中心前缘

**1x1x1 单元的局部范围：**

- X轴: [0, 16] cm
- Y轴: [-8, 8] cm
- Z轴: [0, 16] cm

#### 坐标变换

- 生成时所有坐标以逻辑单元为单位。
- 输出时转换为 UE5 的厘米单位。

---

## 4. 生成核心逻辑 (Core Generation Logic)

### 初始化

- 加载轨道 CSV 并分类（起点、终点、检查点、单/多出口）
- 初始化 `PlacementMap`（记录占用单元）
- 每类轨道建立索引 Map

### 起点放置

1. 在 Build Space 中随机选择逻辑位置
2. 从起点库中随机选择轨道
3. 设置不旋转
4. 标记为占用

### 迭代生成

1. 主循环放置新轨道
2. 从当前轨道出口随机选一个方向和旋转
3. 从合适轨道库中随机选一个匹配
4. **碰撞检测：** 检查是否重叠或越界
5. **放置成功：** 更新占用并记录
6. **失败回溯：** 撤销上一步尝试

### 轨道旋转规则

- **朝向：** 由上一个轨道出口决定
- **自旋：** 从该出口定义的旋转列表中随机选取，不继承上级旋转

---

## 5. 难度与检查点/终点规则 (Difficulty & Checkpoint/Endpoint Rules)

### 难度计算

- **基础难度 (Base Difficulty):** 来自轨道表
- **动态调整系数：**  
  `最终难度 = 基础难度 × (1 + 上一节最终难度 × 0.1)`
  - **分段难度** = `总目标难度 / (检查点数量 + 1)`

### 累加逻辑

每次放置：

- 当前分段难度 += 新轨道最终难度
- 总难度 += 同上

### 检查点生成

- **强制生成：** 当前分段难度 > 上限
- **概率生成：** 当前分段难度 > 下限（50%概率）
- **放置方式：**
  - 插入一个拥有 >=2 出口的轨道作为“检查点触发器”
  - 其一个出口生成检查点 Actor，另一个继续主路径
  - 当前分段难度归零

### 终点生成

- **强制生成：** 总难度 > 上限
- **概率生成：** 总难度 > 下限（75%概率）
- 放置成功后终止生成流程


---

## 6. 输出格式 (Output Format)

- 最终生成结果以脚本可读取形式输出
- 用于 UE5 场景构建（如蓝图或配置 JSON/CSV）

---
